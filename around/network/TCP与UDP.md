## TCP 与 UDP

计算机网络知识庞大而高深，我们就抓主要矛盾，讲重点。

### TCP

先说著名的三次握手与四次挥手

#### 三次握手

这个过程有点像相亲开场白，如下：

![84D3FD24-1662-4012-B242-F68CBED1912E](/assets/84D3FD24-1662-4012-B242-F68CBED1912E.png)

对应到实际的 TCP 连接建立过程，是这样的：

![14D876E3-34E3-4981-AE68-ACA62307D174](/assets/14D876E3-34E3-4981-AE68-ACA62307D174.png)

解释下这里的 SYN 报文和 ACK 报文：

* SYN 报文：起标识作用。当 **SYN=1，ACK=0** 时，表明这是一个连接请求报文。若对方同意连接，则相应报文是 **SYN=1，ACK=1**
* ACK 报文：TCP协议规定，只有ACK=1时网络有效。

**具体过程如下：**

1. 客户端发出请求连接，报文是： SYN=1，ACK=0，seq=x。
2. 服务端进行回复确认，报文是：SYN=1，ACK=1，还有服务端序号 seq=y, 确认号 ack=x+1。
3. 客户端再次确认，这一步用不到 SYN 了，报文是：ACK=1, seq=x+1, ack=y+1。

#### 为什么 TCP 一定要握手三次？

按照常理，一问一答就能建立联系了。

* A 向 B 发出邀请
* B 接受

为什么 TCP 这就要三步呢？

客户端请求报文可能因为”**网络状态**“原因延迟到达服务端。因为延迟，此时报文已失效，而服务端会认为这是一个新的连接请求，向客户端发出响应报文。

如果没有第三次握手，服务端响应后立即建立连接，则这个连接会一直没有数据收发，白白浪费资源。

而有了第三次握手，客户端发送 **ACK=1**，则表示连接未失效。客户端收到，则建立起 TCP 连接。

后续数据交换 ACK 必须为1，保证报文不失效。

一句话总结：**避免和已失效的请求报文建立连接，从而产生错误**。

#### 四次挥手

![7EEE727A-11A1-45CE-B6ED-D5414DE2DFFA](/assets/7EEE727A-11A1-45CE-B6ED-D5414DE2DFFA.png)

新的报文类型：FIN 报文。它表示数据传输完毕，请求释放连接。

**具体过程如下：**

1. 客户端提分手，抛出一个 FIN=1 的报文。
2. 服务器气急，回复了 **ACK=1** 表示同意。
3. 服务器不想被分手，于是也提出分手，FIN=1。
4. 客户端求之不得，回复 **ACK=1**。

这个过程像极了情侣分手，哈哈。

#### 为什么TCP分手一定要挥手四次？

TCP连接是**全双工协议**，双方可以同时向对方发送或接收数据。

所以客户端想断开连接，先要确定服务器是否有数据要发。

然后服务器回复可以断开。

这就是前两次的挥手：确认是否可以分手。

第三步：服务器发送 FIN 报文正式要分手。
第四步：客户端同意，分手成功！

### TCP与UDP的辨析

TCP 协议，通过三次握手，建立了稳定的传输通道。因此，TCP 又被称为“**面向连接的可靠传输**”。

UDP 则恰恰相反，没有握手、同意与否，直接连接。

在 UDP 协议下，数据想发就发，随时可发。因此，UDP 又被称为是“**无连接的不可靠传输**”。

#### UDP 的应用场景

乍一看，UDP这么不可靠，好像没什么存在的意义。

但也有它的过人之处，比如：

* **面向多方**：支持一对多，多对多，多对一。tcp 只能一对一。
* **头部开销小**：头部只有 8 个字节，而 TCP 需要 20 个字节。明显效率更高。
* **随意也是优点**：当连接需要实时建立时，没有反复的握手挥手，反而更灵活

在一些对实时性要求比较强的场合，比如网络电话、视频会议、在线直播这些地方，UDP 比 TCP 更加合适