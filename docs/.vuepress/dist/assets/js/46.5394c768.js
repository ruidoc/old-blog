(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{403:function(t,s,a){"use strict";a.r(s);var n=a(44),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[t._v("#")]),t._v(" 概述")]),t._v(" "),a("p",[t._v("事件循环不仅是 js 必备知识，更是 nodejs 必考题。")]),t._v(" "),a("p",[t._v("从一道面试题说起：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("答案是：1、3、6、4、5、2")]),t._v(" "),a("p",[t._v("为什么是这个顺序？接下来剖析一下")]),t._v(" "),a("h3",{attrs:{id:"event-loop-机制解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#event-loop-机制解析"}},[t._v("#")]),t._v(" Event-Loop 机制解析")]),t._v(" "),a("h4",{attrs:{id:"关键角色剖析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关键角色剖析"}},[t._v("#")]),t._v(" 关键角色剖析")]),t._v(" "),a("p",[t._v("首先要认清楚 3 个角色：")]),t._v(" "),a("ul",[a("li",[t._v("函数调用栈")]),t._v(" "),a("li",[t._v("宏任务（macro-task）队列")]),t._v(" "),a("li",[t._v("微任务（micro-task）队列")])]),t._v(" "),a("p",[t._v("函数调用栈学过了：当引擎第一次遇到 JS 代码时，会产生一个全局执行上下文并压入调用栈。后面每遇到一个函数调用，就会往栈中压入一个新的函数上下文。JS引擎会执行栈顶的函数，执行完毕后，弹出对应的上下文")]),t._v(" "),a("p",[a("img",{attrs:{src:"evernotecid://62701261-7EBA-4D24-ACE2-9FC5416D9815/appyinxiangcom/29093118/ENResource/p107",alt:"b51e56c3342a1cd3b44041c4884e9efd.png"}})]),t._v(" "),a("p",[t._v("一句话：如果你有要执行的逻辑，它首先需要被推入函数调用栈，后续才能被执")]),t._v(" "),a("p",[t._v("宏任务队列、微任务队列是啥？")]),t._v(" "),a("p",[t._v("像 setTimeout 里的逻辑和 promise.then 中的逻辑，这些逻辑是异步的，"),a("strong",[t._v("并不具备立刻进入调用栈的“资格”")])]),t._v(" "),a("p",[t._v("不具备怎么办？排队等呗！")]),t._v(" "),a("p",[t._v("于是这些待执行的任务，按照一定的规则排起长队，等待着被推入调用栈。这个队列，就叫做“任务队列”。")]),t._v(" "),a("p",[t._v("所谓“宏任务”与“微任务”，是对任务的进一步细分。")]),t._v(" "),a("p",[a("img",{attrs:{src:"evernotecid://62701261-7EBA-4D24-ACE2-9FC5416D9815/appyinxiangcom/29093118/ENResource/p108",alt:"4147a541ad77e2c9139a4e380a30fea9.png"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"evernotecid://62701261-7EBA-4D24-ACE2-9FC5416D9815/appyinxiangcom/29093118/ENResource/p109",alt:"e8bd09f514bc0ad966f36d11d9f8b1c6.png"}})]),t._v(" "),a("p",[t._v("注意：script（整体代码）它也是一个宏任务；此外，宏任务中的 setImmediate、微任务中的 process.nextTick 这些都是 Node 独有的。")]),t._v(" "),a("h4",{attrs:{id:"循环过程解读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#循环过程解读"}},[t._v("#")]),t._v(" 循环过程解读")]),t._v(" "),a("p",[t._v("一个完整的 Event Loop 过程，可以概括为以下阶段：")]),t._v(" "),a("ol",[a("li",[t._v("执行并出队一个 macro-task。第一个 macro-task 就是 script 脚本")]),t._v(" "),a("li",[t._v("全局上下文（script 标签）被推入调用栈，同步代码执行(包括函数)。这一步可能会产生新的 macro-task 与 micro-task。")]),t._v(" "),a("li",[t._v("依次执行完并清空上一步产生 micro-task 队列")]),t._v(" "),a("li",[t._v("执行渲染操作，更新界面")]),t._v(" "),a("li",[t._v("检查是否存在 Web worker 任务，如果有，则对其进行处理")])]),t._v(" "),a("p",[t._v("如果走完这5个步骤的过程中产生了新的宏任务，那么宏任务队列的每个任务按照顺序继续走这5个步骤，从而形成了事件循环，直到宏任务队列清空")]),t._v(" "),a("p",[t._v("默认情况下，即初始状态时，调用栈为空，micro 队列空，macro 队列里有且只有一个 script 脚本（整体代码）")]),t._v(" "),a("blockquote",[a("p",[t._v("注意：一个宏任务出队执行时，在第 3 步，不管微任务队列中有多少个任务，都要依次执行直到队列被清空")])]),t._v(" "),a("h3",{attrs:{id:"真题重做-逐行分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#真题重做-逐行分析"}},[t._v("#")]),t._v(" 真题重做，逐行分析")]),t._v(" "),a("p",[t._v("还是文章开头的拿到面试题，用事件循环的角度重新解析一下")]),t._v(" "),a("p",[t._v("首先， script 脚本作为第一个宏任务进入调用栈，并创建了全局上下文。与此同时，宏任务队列被清空。")]),t._v(" "),a("p",[a("img",{attrs:{src:"evernotecid://62701261-7EBA-4D24-ACE2-9FC5416D9815/appyinxiangcom/29093118/ENResource/p110",alt:"156b4a2060742964d06539227313f0bd.png"}})]),t._v(" "),a("p",[t._v("全局代码开始执行，首先先打印出 "),a("strong",[t._v("1")])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("接下来，执行到 setTimeout 这句，一个宏任务被派发了")]),t._v(" "),a("p",[a("img",{attrs:{src:"evernotecid://62701261-7EBA-4D24-ACE2-9FC5416D9815/appyinxiangcom/29093118/ENResource/p111",alt:"36af3b05790ed32283093c45f5601e6f.png"}})]),t._v(" "),a("p",[t._v("再往下走，遇到了一个 Promise")]),t._v(" "),a("blockquote",[a("p",[t._v("注意：Promise 函数体中的代码是同步代码立即执行，只有then和catch中的代码是异步的，需要放到微任务队列")])])])}),[],!1,null,null,null);s.default=e.exports}}]);