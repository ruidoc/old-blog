# 私有仓库

使用 Docker 拉取镜像时，默认会从 Docker Hub 这个公共仓库拉取。

Docker Hub 也可以上传自己的镜像。不过，上传后会对所有人开放，这对于私有镜像来说显然是不够友好的。

为此，Docker 官方提供了工具 `registry` 来帮助搭建私有仓库。

### 安装运行

首先在你要搭建私有仓库的服务器上，安装好 Docker，并拉取 `registry` 镜像：

```sh
$ docker pull registry
```

然后，建立要存储私有镜像的目录，如 `/data/docker/registry`

建好后，创建容器：

```sh
$ docker run -d \
  -p 5000:5000 \
  --restart=always \
  --name registry \
  -v /data/docker/registry:/var/lib/registry \
  registry
```

运行成功后，测试连接情况：

```sh
$ curl http://localhost:5000/v2/_catalog
```

如果返回：

```sh
{"repositories":[]}
```

表示仓库创建成功，此时仓库内没有镜像。

最后，再用 nginx 转发 5000 端口即可。

### 上传镜像

服务端配置好之后，现在来到客户端操作，客户端也需要装好 Docker 环境。

刚才服务端配置简便，没有加登录上传的功能，所以客户端要绕过权限验证，直接上传镜像。

绕过权限验证，需要客户端的 Docker 做以下配置：

```sh
$ vim /etc/docker/daemon.json
```

写入你的服务器域名，不加 http 前缀：

```json
{
  "insecure-registries": ["docker.xxx.com"]
}
```

保存后，重启 docker

```sh
systemctl restart docker
```
