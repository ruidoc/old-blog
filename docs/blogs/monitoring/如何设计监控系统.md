# 思路篇：如何设计监控系统

上一篇我们讲了为什么前端应该有监控系统，大家应该都了解了，生产环境下监控系统有多么重要。

了解了必要性，在开始上手之前，我们还要从全局思考，这个监控系统应该怎么设计？因为这个系统是一个全栈项目，我们需要把前端和后端的关键逻辑梳理一遍。

### 如何采集数据？

做监控的第一步就是采集数据，有真实数据是后面做分析的基础。采集数据的意义就是记录用户在使用过程中的真实操作，尤其是异常触发或者关键步骤记录，可以为后期的统计和追踪做准备。

我们先看异常如何采集：

项目中的异常总体可以分为两大类，一类是`前端异常`，一类是`接口异常`。

前端异常总结一下，大概包括：

- js 代码执行异常
- promise 异常
- 静态资源加载异常
- console.error 异常
- 跨域异常

其中最重要的，也是我们遇到最多的，就是各种各样的 js 代码执行异常。比如类型错误，引用错误等等。然后就是 promise 异常，因为 js 中同步错误和异步错误捕获方式是不一样的，所以他俩要分开来说。

静态资源加载异常，一般指在 html 中引用一些图片地址，第三方 js 地址等，各种原因不能正常加载了，这个也要监听的到。

console.error 异常，一般是在用某个第三方前端框架，他里面自定义了一些错误，会用 `console.error` 抛出来，这类异常也有捕获的必要性。

至于跨域异常，一般在前后端开发时的联调阶段就能发现。不过也保不定后端在线上突然改了什么配置，导致前端跨域，为了安全这个也要监听。

大概就这 5 种错误吧，基本囊括了前端 90% 以上的异常情况。

接口异常属于后端的异常，根据响应结果分类：

- 未响应/超时响应异常
- 4xx 请求异常
- 5xx 服务器异常
- 权限不足

接口异常的判断方式，主要是根据 `http 状态码` 和后端返回的 `业务状态码` 来判断。不过有时候因为网络问题或者服务器问题，前端在发起请求之后迟迟未收到相应，请求被挂起，因此首先要处理这种无响应情况。

有响应的错误我们可以直接取到 http 状态码和后端返回的 data。这里可能不同后端的异常判断标准不一样：有的靠 http 状态码判断；有的是只要请求成功 http 状态码都为 200，然后根据 data 里返回的 error_code 业务状态码来判断。

不过用哪个码判断差别都不大。首先是请求异常，一般是前端传递的参数问题，或者接口验证参数的问题，这类异常的关键是请求参数要保存下来，方便后面排错。

除了请求异常，再有就是服务器内部处理的异常，一般返回 5xx 错误。这类异常的关键信息是报错时间，以及返回的异常说明，拿到后存下来，方便后端去查找日志。

权限不足我觉得也是一类重要的错误。因为现在某些管理系统的权限设计比较复杂，有时候突然莫名其妙的接口调不通，影响用户的下一步操作，这也需要记录和追踪。

### 选一种最好的采集方式

上一步说了采集数据的思路，这一步看，这些数据应该怎么采集最优雅？

首先，按照一般的思路来说，前端某个方法可能出现异常，我们在外面包一层 `try..catch..` 捕获即可。如果是接口请求，那么在 promise 的 catch 方法里同样可以捕获异常。

如果要记录页面访问信息，直接在组件初始化的生命周期里获取数据。

在拿到上述的数据之后，调用一个上报接口，将数据存起来，就完成了最基本的数据采集。

但是这样有一个最大的问题：**捕获和上报的代码要在每个组件中写一遍，这样成本太高，侵入性也太强**。

所以最好的方式，是异常和行为数据都可以 `全局采集`，或者是在某一个统一的地方获取，这样就会非常方便，也可以使其他的客户端接入这套监控系统变得容易。

所以，我的实现方案思路如下：

- 前端异常：在 window 上挂监听器
- 接口异常：axios 拦截器里统一捕获
- 行为数据：全局监听路由变化
- 点击数据：全局监听 click 事件

当然这里只说总体思路，后面的章节会详细展开。

### 还要搭建上报数据的 API 接口

上一步做好的采集数据的方案，当采集到数据之后，接下来就是上报了。

我是一名光荣的前端工程师，因此上报接口，自然选择用 `Node.js` 来开发。

因为这本小册的主旨是从 0 开始，所以选择最简单的 Express 框架，来一步步完善结构，组织成一个可用的 API 架构，支撑我们监控平台需要的所有接口。

具体有哪些功能呢？下面列一下：

- 鉴权认证：API 不能随便调
- 参数验证：不符合预期的参数统统过滤掉
- 数据库：用 mongodb 存储数据
- 查询与统计：获取和分析采集的数据

首先是鉴权认证。这个 API 接口与业务上的后台接口不同，它是一套单独的接口服务。但是它也不能不加限制的请求调用，最好的方式是给它加一个 `jwt` 权限认证。在你的前端项目需要接入监控之前，先申请一个授权的 token，然后请求时带上这个 token，API 接口服务验证通过就可以顺利调用了。

参数验证比较简单，但是我认为很关键，往往有好多的接口不做参数验证，很容易导致莫名其妙的错误。而做好了参数验证，可以保证不符合预期的参数不会进入代码逻辑，同时也杜绝了不规范的数据存入数据库的情况。

这里的参数验证要做两层，第一层是对请求参数验证，第二层是在写入数据库前做验证。

数据库的话，就选对前端最友好的，属于 NoSQL 家族的文档数据库 MongoDB。这个数据库最大的特点是，存储的数据格式类似于 JSON，操作起来就像在 JS 中调用函数，组合 JOSN 数据一样，后面在实战中你就能体会到它的优雅了。

当收集到数据，存储到数据库以后，我们就可以针对数据进行统计和筛选了。

举个最简单的例子，比如我想知道这个产品今天总访问量是多少？有多少个用户访问？哪个时间段的访问流量最高？这就需要对当天的所有数据进行查询统计，得出我们想要的结果。

当然了，这只是最简单的统计。我们前面费劲收集起来的各种数据，就是为了在查询与统计时发挥价值。

### 有了数据，如何利用？

关于采集到的数据如何利用，说白了就是这些数据怎么查。我的思路是从两个方面入手：

- `行为数据`：看某个时间段的趋势，用于统计
- `异常数据`：单条查询，精确定位，排查具体的错误

当然了这只是从总体来说。行为数据也会单条查询，比如我要看某个时间某个用户做了什么操作，这就属于精确查找。异常数据也有统计，比如异常接口触发频率的排行等。

先从行为数据来说。行为数据是指记录用户进入某个页面，以及停留了多久的数据。它的价值是可以很精确的反应出在某个时间段内，用户和页面的实际访问情况。

行为数据的数据量会非常大，在单页面应用中，一般切换路由就会记录一次。因此这些数据最大的意义就是从用户，页面，时间等多个维度去统计你想要的信息，得到一个百分比的结论。

说起来比较抽象，其实就是各种分组统计，计算出我们想要的结果。

异常数据对开发人员来说非常重要，是我们定位和解决 bug 的神辅助。当应用在任何情况下捕捉到异常，存入数据库中，开发人员的第一件事就是找到这条记录，查看触发异常的页面和错误等相关信息，参照信息赶紧去排查错误。

所以不同于行为数据的统计，异常数据可能需要我们根据时间一条一条的列出来，方便团队内伙伴查找详细信息。如果多次触发同一个异常也应该多次记录，这样根据触发频率，也能反应出异常的实际优先级。

前端异常和接口异常，两种异常的查询和展现方式一致，但是存储的数据会有差别，这个可以分开来获取。

基本的数据利用思路就这么多吧。

### 最终的数据展现——可视化图表

上一步我们查出了想要的数据结果，可惜这些结果只能程序员看懂，别人恐怕是看不懂。所以最终为了更直观的反应数据，我们要用前端可视化图表的方式，让这些数据活起来。

这个前端是一个新的应用，正是我们监控系统的前端。

你看，上面做了那么多，这一步才真正到了前端的工作范畴，将接口调通然后做前端图表展示。

这一步其实没什么可说的，主要就是选择一个好用的图表库，对接接口。还有图表的种类多种多样，看哪些数据适合哪种图表，我们结合实际判断一下。

除此之外，这些数据肯定不能所有人都看，所以还要再加登录和注册页面。

### 还差一个报警通知

上一步的数据展现完成后，整个监控系统就基本可用了。

但是还有一种情况，就是有报错信息触发了，如果你不主动刷新页面，你是不知道的。

所以呢，为了保证我们及时的解决 Bug，一个报警通知的功能就非常重要了。它的作用是在异常发生时，第一时间推送给开发人员，这样大家才能立即发现问题，然后用最快的速度去解决，避免遗漏。

报警通知，一般现在通用的方案是对接钉钉或者是企业微信的机器人。

### 最后一步，部署上线

前面的几步，我们完成了采集，API 搭建，数据存储，前端可视化展现，以及监控上报，整个前端监控系统的功能就全部完备了。最后一步就是将这些部署上线，供大家访问。

部署这块主要是 nginx 解析，https 配置，数据库安装，和 nodejs 的应用部署，这个我在最后一个章节也会介绍。

当这个系统上线以后，你就可以尝试在你的任意一个前端项目，根据第一节的采集方法，将采集到的数据通过 API 存起来，然后就可以登入监控系统查看真实的使用数据了。

在这里也祝愿大家坚持学习到最后一章，你一定会有不小的收获。
