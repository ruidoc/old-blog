# 北格前端 2022 计划

结合实际遇到的和要解决的问题，从过去和未来两个方面阐述。

### 2021 年北格前端做了什么？

2021 年初北格前端几乎没有基建，有多个前端项目并且技术栈也不统一：

- 北格 CRM（vue+ant-design-vue）
- 百年/赛学 OEM（vue+element-ui）
- 高考服务项目（jquery+layui，前后端不分离）
- 知荐 Admin（vue+heyui）

这几个项目各有各的写法，整体比较混乱，而且相似的部分难以复用。一开始接手的项目是百年高报系统，当时有许多 bug，排查代码时才发现代码写的极其糟糕，没有标准，几乎不为后期扩展做考虑。

除此之外，项目部署方式非常原始。还是前端本地先打好包，然后连接 FTP，把代码传上去，然后修改旧包的文件夹名，新包传上去再测试。

这种方式的弊端非常明显：

1. 效率太低。在频繁更新部署的场景下，不光慢还容易错。
2. 危险性高。FTP 暴露线上文件夹，靠发布者手工修改，误操作的风险非常高。

因此 2021 的第一个前端基础建设，就是实现**自动化构建和部署**

自动化部署我比较熟悉 Github Action，因此第一步是把前端代码仓库迁移到了 Github。

接下来配置了自动打包构建的脚本，然后首先在测试服上配置了 SSH 免密登陆，将构建后的代码传到服务器。至此前端项目构建方式变的极其简单：**只需要 push 代码，后面会自动执行打包和部署流程**。

这样一来，前端部署效率提升了一大截。

部署问题解决后，接下来又发现了第二个问题：代码合并常有冲突，莫名其妙丢代码。

这个问题的本质是：**没有一套标准的 Git 分支管理策略**，Git 提交和合并非常随意，随着团队人员越来越多，带来的协作问题也会越来越大。

因此在 Git 上前端做了很多工作：

- 放弃 sourcetree，全员统一用命令行。
- 制定 commit 规范，每次提交都用标准格式
- commit 规范校验，不符合则阻止提交
- 多个项目统一的分支和命名规范
- cherry-pick + rebase 的合并策略，保证提交不混乱

这些策略执行下，到现在前端共 4 个人，协作起来也几乎没有提交混乱和冲突问题，且谁提交了什么一目了然。

Git 规范问题解决后，我们又拾起了遗留的另一个问题，就是**代码不规范无标准**的问题。

这个问题前端最后的解决方案是通过 Eslint + Prettier，先是在项目中配置统一的代码风格和规范，然后结合编辑器配置保存时自动格式化，这样实现了所有组员的代码风格统一。

结下来是主攻北格 CRM。这个项目在做的过程中遇到了第四个问题：**线上使用情况未知**

当时的情况是 CRM 已经有好多个模块，因为要改版，我们不知道哪些模块用户在用，所以哪些地方能改，哪些地方不能改，大家都没底，只能靠猜测。所以我在想我们缺一套**前端监控系统**

搭建前端监控平台需要后端服务，于是当时我申请了前端服务器，然后根据我们的场景设计了方案：

总体分为异常监控和用户行为监控两个大方向。

- 采集端：现有前端
- API：Node.js 做接口服务
- 存储：Mongodb 做数据库
- 统计：React 做统计图表展示

React 统计端也就是现在的**北格 CRM 项目面板**，这个项目是首次尝试 React+TypeScript 技术栈。

监控平台目前已上线，可以准确统计各个环境，各时间段的异常和行为数据，尤其对了解线上运行和使用情况非常有用。

监控平台上线后，我发现针对收集的异常，还缺一个**报警通知服务**。

于是前端做的第五件事，是申请了钉钉开发者权限，在监控 API 的基础上，用钉钉机器人实现异常报警通知。因为公司主体在钉钉，@指定人员也非常方便。所以这个通知服务后面又接入了前端部署通知和日报相关的提醒通知。

随着北格 CRM 的功能不断演进，我发现前端的自动部署还缺关键的一环——**快速回滚**。

比如生产环境发现问题后，我们需要马上回滚到上一个版本，但是目前的方案只能是 Git 回滚到上次提交，推送再部署，这个过程至少需要三分钟，这在生产环境是致命的。

因此前端做的第六件事，也是比较关键的事，是**接入 Docker 实现镜像部署**。

因为公司没有 Docker 基础建设，所以首先我们在前端服务器上搭建环境，并建立了私有镜像仓库，用于存放项目打包的镜像。接下来是在前端自动部署脚本中，将之前 SSH 直接上传服务器的部分，替换成打包对应的 docker 镜像，然后上传镜像仓库。

这一步做好后，我们发现除了快速回滚，还需要滚动升级。接下来最关键的一步，就是搭建**基于 Docker Swarm 的容器编排**服务。这个服务不仅能实现几秒内的快速回滚和升级，还支持多服务器的一键扩缩容，在后期多实例部署非常有用。

因为 Docker Swarm 的所有操作是在服务器上进行的，而我们的镜像升级需要在自动化部署脚本中，打包镜像后执行。所以前端做的第七件事，是基于**Docker Api + Node.js**的运维基建。

这个运维基建说白了，就是把 Docker 相关的所有操作都写成了 API 接口。这样在自动化部署的脚本中，调用滚动升级的接口即可实现线上的容器切换。

这一套 Docker 相关的基础建设，经过测试服的不断优化打磨，以及正式服的部署，现在整体稳定。而且我把他们揉合到一起作为“发布平台”接入了北格 CRM 面板，我们可以可视化的操作线上的镜像和服务。

再往后，因为 CRM 移动端的设计与当前情况不符，所以我们基于 PC 端的接口重做了一套 **H5 移动端**。这套端是全组人员第一次用 React+TypeScript 技术栈开发，之前一直是 Vue。现在大家也都熟练了，对前端来说，算是全员的一次技术栈升级，这是第八件事。

第九件事，因为历史原因，后端的接口有三四种不同的返回格式，而且一直无法统一。后面因为接口更新，导致其他接口受影响，返回格式改变，到前端就是之前能用的东西，现在莫名其妙的报错了，而且这个错误还不可控。

为了解决这个问题，前端**引入了 BFF 层**，也就是 Node.js 作为中间服务请求实际接口，然后将所有情况的返回格式，统一处理成相同的格式再返给前端，这样前端避免了接口格式变化带来的异常，也能实现统一处理返回数据。

除了这些关键的技术方案总结，前端在团队工具建设上也做了一些事。

之前大家发日报是组员写好私聊组长，组长再整理发给旭哥，再发群给苏总看。这样一是效率低，二是微信信息非常不利于统计和查找，比如后期要统计本周日报未写率，或者查看某个人的一周日报，就会很困难。

为此前端开发了**日报平台**，供大家方便的写日报。组长有查看组员日报的权限，旭哥苏总有查看所有日报权限。这样的话大家看日报不需要发了，谁写谁没写一目了然。

除此之外还加了日报催写功能，组长点一下会在钉钉群里@未写日报的组员，这是第十件事。

2021 最主要的就这 10 件事情吧，总结一下：

1. 自动化构建和部署
2. Git 分支管理策略
3. 全应用代码规范统一
4. 前端监控平台
5. 报警通知服务
6. Docker 实现镜像部署
7. 运维基建 API
8. React+TypeScript 技术栈
9. Node.js BFF 层
10. 日报平台

### 2022 年北格前端计划做什么？

2022 年北格前端计划，总体两个方向：**巩固**和**开拓**

“巩固“是指 2021 年还未做好的部分，包括：

- 监控平台的前端异常模块
- 跨应用公共组件
- 脚手架工具（检测和生成方向）
- BFF 层能力扩展

“开拓”是指 2022 准备做，以及未来很可能会用到的储备：

- 前端音视频
- 跨端技术（小程序和 APP）
- 需求/进度平台
- 博客平台
- 团队内部工具建设
- 单元测试/自动化测试

巩固的部分就是完善 2021 年未做好的，其中最重要的是基于 Node.js 的中间层服务。现在这个层已有的功能包括：日报接口，docker 运维接口，钉钉通知接口，监控日志接口，接口聚合转发等。

未来这一层还会做更多。我对 Node.js 的定位是 **BFF 层**，**内部平台 API** 和 **CLI 工具**，它的作用首先是更好的服务前端，完善前端周边的工具链；其次是服务团队内部，产出一些可以帮助我们高效协作的平台和工具。

“开拓”部分可以大概说一下我个人的想法。

**前端音视频**：这个部分主要是浏览器，或者其他客户端之间可能相互视频通信。这个是基于我们现在的业务情况可能出现的需求，这方面需要前端/跨端做一些准备。

**跨端技术**：跨端技术分为两个方向。方向一是小程序，我们要实现小程序和 web-h5 如何共用一套代码。方向二是 APP，我们要实现安卓和 IOS 如何共用一套代码。如果后续我们的业务需要做 C 端的话，那么这个方向很可能会用的到。

**需求/进度平台**：这个是我一直想做的，也是可以和监控平台对接的一个平台。为啥需要这个平台？因为我们现在的需求是零散的，靠坤哥写在 wiki 里发群通知，其实好多人都不知道需求是啥，没有一个整体脉络。

因此现在缺一个统一的结构化的平台，可以一目了然的看到有哪些需求，哪些完成了，哪些和我有关，哪些是变更了，变更通知和记录，然后需求点后面是开发和测试进度，又不要像市面上的产品那么复杂。总之就是即便没有参与需求讨论会的人，或者苏总，旭哥，想了解需求进度，打开页面就能看到当前最新情况。

**博客平台**：这个平台是一个基于 markdown 语法，对书写技术笔记很友好的平台。搭这个平台的目的是为了做团队的技术沉淀。因为大家每天辛辛苦苦的开发，遇到的问题和方案如果不记录并共享的话，那么团队的经验是很难沉淀下来的。再有这个平台会是前端技术分享记录的地方。

**团队内部工具建设**：这个也是一个大方向。因为我们技术部目前主要是对外做产品，随着我们团队越来越大，而且员工分布在各个城市，我们很有必要对内提供一些协作增效的工具，来帮助其他部门的人解决问题，提高效率，这也能提高我们技术部在公司的影响力。（如统一的日报统计，考勤统计，信息公示平台，一些人事，合同，采购的平台）

**单元测试/自动化测试**：因为我们公司没有专业的测试，平时项目测试也是大家手动点点点，效率低下而且免不了遗漏。所以首先前端要对每个模块编写单元测试，上传前先跑一遍单测。然后再用无头浏览器模拟测试环境下的操作步骤，进行自动化的流程测试，收集异常，使测试精准度更高一些，线上应用就更可靠一点。

大概就是这些吧。我对前端团队的定位，就是除了前端本职的工作，还要对产品交付的体验和质量负责，和做团队内部增效工具的产出。

2022 年还希望前端再进 2 个人，我们能做更多事情。

以上我提到的事情，欢迎旭哥和苏总考虑。如果有其他的计划，或者有重点发展的方向，可以与我私聊，我好做下一步的筹划和准备。感谢 🙏🙏🙏。
